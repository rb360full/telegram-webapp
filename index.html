<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تبدیل گفتار به متن</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6;
            direction: rtl;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-8 w-full max-w-2xl mx-auto flex flex-col items-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-gray-800">تبدیل گفتار به متن</h1>
        <p class="text-lg text-gray-600 mb-6 text-center">
            روی دکمه زیر کلیک کنید و شروع به صحبت کردن کنید.
        </p>
        
        <button id="startStopBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
            شروع به صحبت
        </button>

        <div id="status" class="mt-6 text-center text-lg font-medium text-gray-700">
            وضعیت: آماده
        </div>

        <!-- مخزن نهایی: متن استخراج شده در اینجا ذخیره می‌شود و پاک نمی‌شود. -->
        <div class="mt-8 w-full p-4 bg-gray-100 rounded-xl border border-gray-200 min-h-[200px] overflow-auto">
            <p id="transcription" class="text-gray-800 text-base leading-loose whitespace-pre-wrap"></p>
        </div>

        <!-- متن لحظه‌ای: متن موقتی که در حال تشخیص است در اینجا نمایش داده می‌شود. -->
        <div class="mt-2 w-full p-4 bg-gray-50 rounded-xl border border-gray-200 min-h-[50px] overflow-auto">
            <p id="interimTranscription" class="text-gray-500 text-sm leading-loose whitespace-pre-wrap"></p>
        </div>

        <div class="mt-4 w-full flex justify-center gap-4">
            <button id="sendBtn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300">
                📤 ارسال به تلگرام
            </button>
            <button id="testBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                🧪 تست ارسال
            </button>
        </div>
    </div>

    <script>
        // تنظیم Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // تنظیم رنگ‌های Web App
        tg.setHeaderColor('#0088cc');
        tg.setBackgroundColor('#f0f2f5');
        
        // تست اتصال
        console.log('Telegram Web App initialized:', tg);
        console.log('User:', tg.initDataUnsafe?.user);

        const startStopBtn = document.getElementById('startStopBtn');
        const statusEl = document.getElementById('status');
        const transcriptionEl = document.getElementById('transcription');
        const interimTranscriptionEl = document.getElementById('interimTranscription');
        const sendBtn = document.getElementById('sendBtn');
        const testBtn = document.getElementById('testBtn');

        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!window.SpeechRecognition) {
            statusEl.textContent = 'متأسفانه مرورگر شما از "Web Speech API" پشتیبانی نمی‌کند.';
            startStopBtn.disabled = true;
            startStopBtn.textContent = 'غیرفعال';
        } else {
            const recognition = new SpeechRecognition();
            recognition.interimResults = true;
            recognition.lang = 'fa-IR';
            recognition.continuous = false;

            let isRecognizing = false;
            let final_transcript = '';
            let timeoutId = null;

            const startRecognition = () => {
                final_transcript = '';
                interimTranscriptionEl.textContent = '';
                recognition.start();
            };

            recognition.onstart = () => {
                isRecognizing = true;
                statusEl.textContent = 'وضعیت: در حال گوش دادن... 🔴';
                startStopBtn.textContent = 'توقف';
            };

            recognition.onend = () => {
                if (isRecognizing) {
                    recognition.start();
                } else {
                    statusEl.textContent = 'وضعیت: آماده';
                    startStopBtn.textContent = 'شروع به صحبت';
                }
            };
            
            recognition.onerror = (event) => {
                statusEl.textContent = `خطا: ${event.error}`;
                console.error('Speech Recognition Error:', event);
                isRecognizing = false;
                startStopBtn.textContent = 'شروع به صحبت';
            };

            recognition.onresult = (event) => {
                clearTimeout(timeoutId);
                let interim_transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript + ' ';
                        interimTranscriptionEl.textContent = '';
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                transcriptionEl.textContent = final_transcript;
                interimTranscriptionEl.textContent = interim_transcript;

                timeoutId = setTimeout(() => {
                    if (isRecognizing) {
                        recognition.stop();
                    }
                }, 2000); 
            };

            startStopBtn.onclick = () => {
                if (startStopBtn.textContent === 'توقف') {
                    recognition.stop();
                    isRecognizing = false;
                } else {
                    recognition.start();
                }
            };

            sendBtn.onclick = () => {
                const textToSend = final_transcript.trim();
                if (textToSend) {
                    try {
                        // نمایش پیام در حال ارسال
                        tg.showAlert('📤 در حال ارسال متن...');
                        
                        // ارسال به تلگرام
                        const dataToSend = JSON.stringify({
                            type: 'speech_to_text',
                            text: textToSend,
                            timestamp: Date.now()
                        });
                        
                        console.log('Sending data:', dataToSend);
                        tg.sendData(dataToSend);
                        
                        tg.showAlert('✅ متن با موفقیت ارسال شد!');
                        console.log('Sent to Telegram:', textToSend);
                        
                        // بستن Web App
                        setTimeout(() => {
                            tg.close();
                        }, 1500);
                        
                    } catch (error) {
                        console.error('Error sending to Telegram:', error);
                        tg.showAlert('❌ خطا در ارسال متن!');
                    }
                } else {
                    tg.showAlert('لطفاً ابتدا متن را تشخیص دهید!');
                }
            };

            testBtn.onclick = () => {
                try {
                    // تست ارسال
                    const testData = JSON.stringify({
                        type: 'speech_to_text',
                        text: 'تست ارسال از Web App',
                        timestamp: Date.now()
                    });
                    
                    console.log('Sending test data:', testData);
                    console.log('Telegram WebApp object:', tg);
                    console.log('sendData method:', tg.sendData);
                    
                    tg.sendData(testData);
                    
                    tg.showAlert('🧪 داده تست ارسال شد!');
                    
                } catch (error) {
                    console.error('Error sending test data:', error);
                    tg.showAlert('❌ خطا در ارسال تست!');
                }
            };
        }
    </script>
</body>
</html>
