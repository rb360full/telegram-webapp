<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ¨Ø¯ÛŒÙ„ Ú¯ÙØªØ§Ø± Ø¨Ù‡ Ù…ØªÙ†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6;
            direction: rtl;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-8 w-full max-w-2xl mx-auto flex flex-col items-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-gray-800">ØªØ¨Ø¯ÛŒÙ„ Ú¯ÙØªØ§Ø± Ø¨Ù‡ Ù…ØªÙ†</h1>
        <p class="text-lg text-gray-600 mb-6 text-center">
            Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ùˆ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ ØµØ­Ø¨Øª Ú©Ø±Ø¯Ù† Ú©Ù†ÛŒØ¯.
        </p>
        
        <button id="startStopBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
            Ø´Ø±ÙˆØ¹ Ø¨Ù‡ ØµØ­Ø¨Øª
        </button>

        <div id="status" class="mt-6 text-center text-lg font-medium text-gray-700">
            ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡
        </div>

        <!-- Ù…Ø®Ø²Ù† Ù†Ù‡Ø§ÛŒÛŒ: Ù…ØªÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù¾Ø§Ú© Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. -->
        <div class="mt-8 w-full p-4 bg-gray-100 rounded-xl border border-gray-200 min-h-[200px] overflow-auto">
            <p id="transcription" class="text-gray-800 text-base leading-loose whitespace-pre-wrap"></p>
        </div>

        <!-- Ù…ØªÙ† Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ: Ù…ØªÙ† Ù…ÙˆÙ‚ØªÛŒ Ú©Ù‡ Ø¯Ø± Ø­Ø§Ù„ ØªØ´Ø®ÛŒØµ Ø§Ø³Øª Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. -->
        <div class="mt-2 w-full p-4 bg-gray-50 rounded-xl border border-gray-200 min-h-[50px] overflow-auto">
            <p id="interimTranscription" class="text-gray-500 text-sm leading-loose whitespace-pre-wrap"></p>
        </div>

        <div class="mt-4 w-full flex justify-center gap-4">
            <button id="sendBtn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300">
                ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
            </button>
            <button id="testBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                ğŸ§ª ØªØ³Øª Ø§Ø±Ø³Ø§Ù„
            </button>
        </div>
    </div>

    <script>
        // ØªÙ†Ø¸ÛŒÙ… Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Web App
        tg.setHeaderColor('#0088cc');
        tg.setBackgroundColor('#f0f2f5');
        
        // ØªØ³Øª Ø§ØªØµØ§Ù„
        console.log('Telegram Web App initialized:', tg);
        console.log('User:', tg.initDataUnsafe?.user);

        const startStopBtn = document.getElementById('startStopBtn');
        const statusEl = document.getElementById('status');
        const transcriptionEl = document.getElementById('transcription');
        const interimTranscriptionEl = document.getElementById('interimTranscription');
        const sendBtn = document.getElementById('sendBtn');
        const testBtn = document.getElementById('testBtn');

        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!window.SpeechRecognition) {
            statusEl.textContent = 'Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² "Web Speech API" Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.';
            startStopBtn.disabled = true;
            startStopBtn.textContent = 'ØºÛŒØ±ÙØ¹Ø§Ù„';
        } else {
            const recognition = new SpeechRecognition();
            recognition.interimResults = true;
            recognition.lang = 'fa-IR';
            recognition.continuous = false;

            let isRecognizing = false;
            let final_transcript = '';
            let timeoutId = null;

            const startRecognition = () => {
                final_transcript = '';
                interimTranscriptionEl.textContent = '';
                recognition.start();
            };

            recognition.onstart = () => {
                isRecognizing = true;
                statusEl.textContent = 'ÙˆØ¶Ø¹ÛŒØª: Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†... ğŸ”´';
                startStopBtn.textContent = 'ØªÙˆÙ‚Ù';
            };

            recognition.onend = () => {
                if (isRecognizing) {
                    recognition.start();
                } else {
                    statusEl.textContent = 'ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡';
                    startStopBtn.textContent = 'Ø´Ø±ÙˆØ¹ Ø¨Ù‡ ØµØ­Ø¨Øª';
                }
            };
            
            recognition.onerror = (event) => {
                statusEl.textContent = `Ø®Ø·Ø§: ${event.error}`;
                console.error('Speech Recognition Error:', event);
                isRecognizing = false;
                startStopBtn.textContent = 'Ø´Ø±ÙˆØ¹ Ø¨Ù‡ ØµØ­Ø¨Øª';
            };

            recognition.onresult = (event) => {
                clearTimeout(timeoutId);
                let interim_transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript + ' ';
                        interimTranscriptionEl.textContent = '';
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                transcriptionEl.textContent = final_transcript;
                interimTranscriptionEl.textContent = interim_transcript;

                timeoutId = setTimeout(() => {
                    if (isRecognizing) {
                        recognition.stop();
                    }
                }, 2000); 
            };

            startStopBtn.onclick = () => {
                if (startStopBtn.textContent === 'ØªÙˆÙ‚Ù') {
                    recognition.stop();
                    isRecognizing = false;
                } else {
                    recognition.start();
                }
            };

            sendBtn.onclick = () => {
                const textToSend = final_transcript.trim();
                if (textToSend) {
                    try {
                        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„
                        tg.showAlert('ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ†...');
                        
                        // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
                        const dataToSend = JSON.stringify({
                            type: 'speech_to_text',
                            text: textToSend,
                            timestamp: Date.now()
                        });
                        
                        console.log('Sending data:', dataToSend);
                        tg.sendData(dataToSend);
                        
                        tg.showAlert('âœ… Ù…ØªÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!');
                        console.log('Sent to Telegram:', textToSend);
                        
                        // Ø¨Ø³ØªÙ† Web App
                        setTimeout(() => {
                            tg.close();
                        }, 1500);
                        
                    } catch (error) {
                        console.error('Error sending to Telegram:', error);
                        tg.showAlert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ†!');
                    }
                } else {
                    tg.showAlert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù…ØªÙ† Ø±Ø§ ØªØ´Ø®ÛŒØµ Ø¯Ù‡ÛŒØ¯!');
                }
            };

            testBtn.onclick = () => {
                try {
                    // ØªØ³Øª Ø§Ø±Ø³Ø§Ù„
                    const testData = JSON.stringify({
                        type: 'speech_to_text',
                        text: 'ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ Ø§Ø² Web App',
                        timestamp: Date.now()
                    });
                    
                    console.log('Sending test data:', testData);
                    console.log('Telegram WebApp object:', tg);
                    console.log('sendData method:', tg.sendData);
                    
                    tg.sendData(testData);
                    
                    tg.showAlert('ğŸ§ª Ø¯Ø§Ø¯Ù‡ ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!');
                    
                } catch (error) {
                    console.error('Error sending test data:', error);
                    tg.showAlert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ØªØ³Øª!');
                }
            };
        }
    </script>
</body>
</html>
